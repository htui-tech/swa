# SWA 应用架构概览

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        SWA Web 应用                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │
│  │  HTTP 请求  │───▶│  Actix-web  │───▶│ 中间件链    │          │
│  │  (GET/POST) │    │   框架      │    │ 处理        │          │
│  └─────────────┘    └─────────────┘    └─────────────┘          │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    中间件链 (7个中间件)                      │ │
│  │                                                             │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │  日志   │ │IP访问控制│ │ 缓存检查 │ │ 主题选择 │ │ 模板匹配│ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  │                                                             │ │
│  │  ┌─────────┐ ┌─────────┐                                   │ │
│  │  │上下文数据│ │  认证   │                                   │ │
│  │  └─────────┘ └─────────┘                                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    统一模板处理                              │ │
│  │                                                             │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │ │
│  │  │  配置路由    │    │  智能匹配    │    │  404处理    │      │ │
│  │  │  匹配        │    │  成功        │    │  失败        │      │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   智能模板查找 (在中间件中)                  │ │
│  │                                                             │ │
│  │  1. Public目录: public/{path}/index.html                   │ │
│  │  2. 主题目录: themes/{theme}/{template}.html               │ │
│  │  3. 根目录: templates/{template}.html                      │ │
│  │  4. 404处理: 返回错误页面                                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    插件数据处理                              │ │
│  │                                                             │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │ │
│  │  │  data_for   │    │ global_data │    │api_dispatch │      │ │
│  │  │  路径数据    │    │  全局数据    │    │  API分发    │      │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    模板渲染                                  │ │
│  │                                                             │ │
│  │  1. 确保模板已注册                                           │ │
│  │  2. 合并数据源 (插件 + 全局 + 上下文)                        │ │
│  │  3. Handlebars 渲染                                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    缓存和响应                                │ │
│  │                                                             │ │
│  │  1. 写入缓存 (如果启用)                                      │ │
│  │  2. 返回 HTTP 响应                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件说明

### 1. 中间件链 (Middleware Chain) - 优化后的顺序
- **日志中间件**: 记录所有请求信息
- **IP访问控制**: 安全检查优先，可配置启用/禁用
- **缓存检查**: 如果已缓存，直接返回响应
- **主题选择**: 根据域名选择主题
- **模板匹配**: 结合配置路由和智能匹配，统一处理
- **上下文数据**: 注入全局数据
- **认证**: 处理用户认证

### 2. 插件系统 (Plugin System)
- **动态加载**: 运行时加载 `.dylib` 插件，支持跨平台编译
- **数据处理**: 插件可以处理路径数据、全局数据
- **API分发**: 插件可以处理API请求
- **模板指定**: 插件可以指定使用的模板
- **配置管理**: 支持插件配置和全局配置传递
- **缓存支持**: 插件数据支持内存缓存，提高性能
- **错误隔离**: 插件错误不影响主应用运行

### 3. 智能模板匹配 (Smart Template Matching) - 在中间件中实现
- **配置路由优先**: 首先尝试匹配 `routes.json` 中的配置路由
- **智能查找**: 配置路由失败时，按优先级查找模板：
  - Public目录: `public/{path}/index.html`
  - 主题目录: `themes/{theme}/{template}.html`
  - 根目录: `templates/{template}.html`
- **404处理**: 所有匹配失败时，返回404页面
- **统一处理**: 在路由匹配中间件中统一处理所有情况

### 4. 缓存系统 (Cache System)
- **混合策略**: hybrid 缓存模式
- **个性化**: 包含用户ID的缓存键
- **TTL**: 1小时过期时间

## 数据流向

```
HTTP请求 → 中间件链 → 统一模板处理 → 插件数据 → 模板渲染 → 缓存 → HTTP响应
```

### 详细流程
1. **HTTP请求** → 接收用户请求
2. **中间件链** → 按顺序处理：日志 → IP控制 → 缓存检查 → 主题选择 → 模板匹配 → 上下文数据 → 认证
3. **统一模板处理** → 根据中间件结果：配置路由匹配 / 智能匹配 / 404处理
4. **插件数据** → 从插件获取路径数据和全局数据
5. **模板渲染** → 合并数据并渲染模板
6. **缓存** → 写入缓存（如果启用）
7. **HTTP响应** → 返回最终响应

## 关键特性

1. **安全检查**: IP访问控制可配置，默认启用重定向到警告页面
2. **插件驱动**: 数据处理完全由插件控制
3. **智能匹配**: 在中间件中统一处理配置路由和智能模板匹配
4. **性能优化**: 缓存检查提前，避免不必要的处理
5. **异步处理**: 全异步架构，高性能
6. **多主题**: 支持多主题系统
7. **懒加载**: 模板按需加载
8. **统一处理**: 所有模板匹配逻辑集中在中间件中

## 扩展点

- **中间件**: 可以添加新的中间件
- **插件**: 可以开发新的插件
- **模板**: 可以添加新的模板
- **配置**: 可以扩展配置选项

## 插件开发支持

### 插件编译脚本
- **跨平台支持**: 支持 macOS、Linux、macOS ARM64
- **构建模式**: 支持 debug 和 release 模式
- **自动部署**: 自动复制到 plugins 目录

```bash
# 编译插件示例
./build-plugin-simple.sh macos bas-site debug
./build-plugin-simple.sh linux bas-site release
./build-plugin-simple.sh macos-arm bas-site release
```

### 插件接口
- **SwaPlugin Trait**: 统一的插件接口
- **异步支持**: 全异步插件方法
- **配置传递**: 支持插件配置和全局配置
- **错误处理**: 优雅的错误处理和日志记录

### 插件功能
- **数据处理**: `data_for` 方法处理路径数据
- **全局数据**: `global_data` 方法提供全局数据
- **API分发**: `api_dispatch` 方法处理API请求
- **模板指定**: 插件可以指定使用的模板名称

## 性能特性

### 缓存机制
- **内存缓存**: 全局数据5分钟缓存
- **Redis支持**: 分布式缓存支持
- **模板缓存**: 编译后模板缓存
- **插件缓存**: 插件数据缓存支持

### 错误处理
- **优雅降级**: 插件错误不影响主应用
- **详细日志**: 统一的日志记录系统
- **错误隔离**: 插件错误隔离处理
- **调试支持**: 详细的调试信息输出

## 文档资源

- [README.md](README.md) - 项目概述和快速开始
- [插件开发指南](PLUGIN_DEVELOPMENT_GUIDE.md) - 详细的插件开发文档
- [部署指南](DEPLOYMENT_GUIDE.md) - 生产环境部署指南
- [API参考](API_REFERENCE.md) - 完整的API接口文档
- [请求流程文档](REQUEST_FLOW_DOCUMENTATION.md) - 详细的请求处理流程
